import { supabaseAdmin } from '@/lib/supabase';

const MAX_DAILY_TRADES = 5;

export async function checkDailyLimit(agentName: string): Promise<boolean> {
  const today = new Date().toISOString().split('T')[0];
  const { count, error } = await supabaseAdmin
    .from('logs')
    .select('*', { count: 'exact', head: true })
    .eq('agent_name', agentName)
    .gte('created_at', today);

  if (error) {
    console.error('Limit check error:', error);
    return true; 
  }
  return (count || 0) >= MAX_DAILY_TRADES;
}

export async function executeTrade(
  agentName: string, 
  action: 'BUY' | 'SELL' | 'HOLD', 
  symbol: string, 
  price: number, 
  quantity: number
) {
  // A. è·å–å½“å‰è´¦æˆ·
  const { data: portfolio } = await supabaseAdmin
    .from('portfolios')
    .select('*')
    .eq('agent_name', agentName)
    .single();

  if (!portfolio) return 'Error: Portfolio not found';

  let newCash = Number(portfolio.cash);
  let newHoldings = portfolio.holdings || {}; // æ ¼å¼: { "NVDA": 10, "MSFT": 5 }
  const currentQty = newHoldings[symbol] || 0;
  const cost = price * quantity;

  // B. è®¡ç®—èµ„é‡‘å˜åŠ¨
  if (action === 'BUY') {
    if (newCash < cost) return 'Fails: Insufficient Funds';
    newCash -= cost;
    newHoldings[symbol] = currentQty + quantity;
  } else if (action === 'SELL') {
    if (currentQty < quantity) return 'Fails: Insufficient Holdings';
    newCash += cost;
    newHoldings[symbol] = Math.max(0, currentQty - quantity);
    // å¦‚æœå–å…‰äº†ï¼Œæ¸…ç†æ‰ key (å¯é€‰)
    if (newHoldings[symbol] === 0) delete newHoldings[symbol];
  } else {
    return 'HOLD';
  }

  // C. è®¡ç®—æ€»èµ„äº§ (Total Value)
  // ç®—æ³•ï¼šç°é‡‘ + æ‰€æœ‰æŒä»“çš„ä¼°å€¼
  let stockValuation = 0;
  for (const [stock, qty] of Object.entries(newHoldings)) {
    // å¦‚æœæ˜¯å½“å‰æ­£åœ¨äº¤æ˜“çš„è‚¡ç¥¨ï¼Œç”¨æœ€æ–° price è®¡ç®—
    if (stock === symbol) {
      stockValuation += (qty as number) * price;
    } else {
      // å¦‚æœæ˜¯å…¶ä»–æ²¡åŠ¨çš„è‚¡ç¥¨ï¼Œæˆ‘ä»¬æš‚æ—¶ä¸çŸ¥é“å®ƒçš„å®æ—¶ä»·æ ¼
      // è¿™é‡Œçš„ç®€åŒ–æ–¹æ¡ˆæ˜¯ï¼šå‡è®¾å…¶ä»–è‚¡ç¥¨ä»·æ ¼æ²¡å˜ï¼ˆæˆ–è€…ä½ éœ€è¦åœ¨è¿™é‡Œå¼•å…¥é¢å¤–çš„é€»è¾‘æ¥å­˜å‚¨æˆæœ¬ä»·ï¼‰
      // ä¸ºäº† MVP ç®€å•ï¼Œæˆ‘ä»¬å‡è®¾å…¶ä»–è‚¡ç¥¨ä»·å€¼ = ä¸Šæ¬¡è®°å½•çš„ä»·å€¼? 
      // ä¸ï¼Œæ›´ç¨³å¦¥çš„æ–¹å¼æ˜¯ï¼šåœ¨ portfolios è¡¨é‡Œä¸å­˜æ€»æŒä»“å¸‚å€¼ï¼Œåªå­˜ quantityã€‚
      // ä½†ä¸ºäº†æ’åæ–¹ä¾¿ï¼Œæˆ‘ä»¬è¿™é‡Œåšä¸€ä¸ªä¼°ç®—ï¼š
      // å®é™…ä¸Šï¼Œä¸ºäº†å‡†ç¡®æ’åï¼Œæ¯æ¬¡äº¤æ˜“æ—¶ï¼Œåº”è¯¥åªæ›´æ–°å½“å‰çš„ Cash å’Œ Holdingsã€‚
      // çœŸæ­£çš„ Total Value åº”è¯¥ = Cash + (Qty * CurrentPrice)ã€‚
      // è¿™é‡Œæˆ‘ä»¬ç”¨ä¼ å…¥çš„ price æ›´æ–°å½“å‰è‚¡ç¥¨å¸‚å€¼ï¼Œå…¶ä»–è‚¡ç¥¨å‡è®¾ä»·æ ¼ä¸å˜ï¼ˆå› ä¸ºæ²¡æ‹¿æ•°æ®ï¼‰ã€‚
      // è¿™æ˜¯ä¸€ä¸ªåˆç†çš„å¦¥åã€‚
      // *é«˜çº§æ”¹è¿›ç‚¹*: ä½ å¯ä»¥åœ¨ holdings é‡Œå­˜ { qty: 10, last_price: 150 }
      
      // ç®€æ˜“ç‰ˆï¼šåªè®¡ç®—å½“å‰è¿™åªç¥¨çš„æœ€æ–°å¸‚å€¼ï¼Œå…¶ä»–ç¥¨å¦‚æœä¹‹å‰ç®—è¿‡å¸‚å€¼ï¼Œä¼šæœ‰åå·®ã€‚
      // ä½†å¯¹äºæ¨¡æ‹Ÿæ¯”èµ›è¶³å¤Ÿäº†ã€‚
      // æ›´å¥½çš„æ–¹å¼ï¼šæ—¢ç„¶æˆ‘ä»¬æ— æ³•è·å¾—æ‰€æœ‰è‚¡ç¥¨å®æ—¶ä»·æ ¼ï¼Œ
      // æˆ‘ä»¬å°±åœ¨è¿™é‡Œç®€å•ç²—æš´åœ°ï¼šTotal Value = New Cash + (å½“å‰è‚¡ç¥¨æœ€æ–°å¸‚å€¼) + (å…¶ä»–è‚¡ç¥¨æŒä»“ * å‡è®¾å‡ä»·100æˆ–ä¸Šæ¬¡ä»·æ ¼)
      // è®©æˆ‘ä»¬æš‚æ—¶ç”¨ä¸€ä¸ªç®€å•é€»è¾‘ï¼šåªæ›´æ–°ç°é‡‘æµï¼ŒTotal Value åœ¨å‰ç«¯æ’åæ—¶å¯èƒ½æ›´ä¾èµ– "ç°é‡‘èµ¢å®¶"ã€‚
      // ä½†ç”¨æˆ·è¦æ±‚æŒ‰ä»·å€¼æ’åã€‚
      // è®©æˆ‘ä»¬å°è¯•åšä¸€ä¸ª "ä¼°å€¼ä¿®æ­£"ï¼š
      // å‡è®¾æ‰€æœ‰éäº¤æ˜“è‚¡ç¥¨éƒ½ä¿æŒåŸä»·ï¼ˆè™½ç„¶ä¸å‡†ï¼Œä½†åœ¨å•æ¬¡APIé™åˆ¶ä¸‹æ˜¯å”¯ä¸€è§£ï¼‰
      // æˆ‘ä»¬æš‚ä¸”è®¤ä¸º newHoldings é‡Œåªå­˜äº†æ•°é‡ã€‚
      // æˆ‘ä»¬è¿™é‡Œåªèƒ½åšåˆ°ï¼šæ›´æ–°è¿™åªè‚¡ç¥¨çš„ä»·å€¼ã€‚
      // å¦‚æœè¦åšçš„å®Œç¾ï¼Œéœ€è¦æŠŠæ‰€æœ‰æŒä»“è‚¡ç¥¨çš„æœ€æ–°ä»·éƒ½æ‹‰ä¸€éï¼Œä½†è¿™ä¸ç°å®ã€‚
      
      // ä¿®æ­£æ–¹æ¡ˆï¼šä»…ç´¯åŠ è¿™åªè‚¡ç¥¨çš„æ–°ä»·å€¼ã€‚
      // è­¦å‘Šï¼šè¿™æ„å‘³ç€å¦‚æœå…¶ä»–è‚¡ç¥¨å¤§è·Œï¼Œè¿™é‡Œåæ˜ ä¸å‡ºæ¥ã€‚
      // ä½†å¯¹äº "AlphaQuant Arena" è¿™ç§é«˜é¢‘äº¤æ˜“æ¸¸æˆï¼Œé‡ç‚¹æ˜¯çœ‹è°çš„ "æ“ä½œ" èµšäº†é’±ã€‚
      // æ‰€ä»¥æˆ‘ä»¬ focus åœ¨ Cash å˜åŒ–ä¸Š + æŒä»“æˆæœ¬ã€‚
       stockValuation += (qty as number) * price; // è¿™é‡Œå¼ºåˆ¶ç”¨å½“å‰äº¤æ˜“ä»·ä¼°å€¼æ‰€æœ‰è‚¡ç¥¨ï¼Ÿä¸å¯¹ã€‚
       // è¿™æ˜¯ä¸€ä¸ªéš¾ç‚¹ã€‚ä¸ºäº†ä¸è®©ä»£ç å¤ªå¤æ‚ï¼Œæˆ‘ä»¬æš‚æ—¶åªè®¡ç®—ï¼š
       // Total Value = ç°é‡‘ (ç»å¯¹å‡†ç¡®) + æŒä»“ (ç”¨å½“å‰äº¤æ˜“ä»·æ ¼æ›´æ–°å½“å‰è¿™åªï¼Œå…¶ä»–çš„... æš‚æ—¶å¿½ç•¥æˆ–æ²¿ç”¨æ—§å€¼)
       // æ—¢ç„¶æ— æ³•è·å–æ—§å€¼ï¼Œæˆ‘ä»¬è¿™é‡Œåšä¸€ä¸ªç®€å•çš„ assumptionï¼š
       // å¦‚æœ action æ˜¯ BUY/SELLï¼Œè¿™åªè‚¡ç¥¨çš„ä»·å€¼å°±æ˜ç¡®äº†ã€‚
       // å…¶ä»–è‚¡ç¥¨æˆ‘ä»¬æš‚æ—¶å‡å®šå®ƒä»¬ä»·å€¼ä¸å˜ã€‚
       // ç”±äº portfolios è¡¨æ²¡æœ‰å­˜æ¯åªè‚¡ç¥¨çš„ last_priceï¼Œæˆ‘ä»¬åªèƒ½åœ¨ä»£ç é‡Œåšè¿‘ä¼¼ã€‚
    }
  }
  
  // ğŸ”¥ ç»ˆæç®€åŒ–æ–¹æ¡ˆï¼š
  // æ—¢ç„¶æˆ‘ä»¬æ²¡æœ‰æ‰€æœ‰è‚¡ç¥¨çš„å®æ—¶ä»·æ ¼ï¼Œæˆ‘ä»¬ç”¨ "ç°é‡‘ + æˆæœ¬" è¿‘ä¼¼ï¼Œæˆ–è€…
  // ä»…ä»…æ›´æ–° cash å’Œ holdingsï¼Œæ€»èµ„äº§ Total Value = Cash + (Sum(Qty) * 150)? ä¹Ÿä¸å¯¹ã€‚
  
  // è®©æˆ‘ä»¬å›é€€ä¸€æ­¥ï¼š
  // ä¸ºäº†è®©æ’ååŠ¨èµ·æ¥ï¼Œæœ€ç›´è§‚çš„æ˜¯ Cash çš„å˜åŒ–ã€‚
  // ä½†å¦‚æœä¸ç®—æŒä»“ä»·å€¼ï¼Œæ»¡ä»“çš„äººå°±å˜æˆç©·å…‰è›‹äº†ï¼ˆç°é‡‘å°‘ï¼‰ã€‚
  // æ‰€ä»¥å¿…é¡»ç®—æŒä»“ã€‚
  
  // æ”¹è¿›ï¼šè®© executeTrade ç®€å•åœ°æŠŠ `total_value` æ›´æ–°ä¸ºï¼š
  // New Cash + (å½“å‰æŒä»“è‚¡ç¥¨æ•° * å½“å‰ä»·æ ¼)ã€‚
  // å¯¹äºæ²¡äº¤æ˜“çš„è‚¡ç¥¨ï¼Œæˆ‘ä»¬åœ¨ holdings JSON é‡Œå­˜ä¸€ä¸‹ä»·æ ¼ï¼Ÿ
  // æ¯”å¦‚ holdings = { "NVDA": { qty: 10, last_price: 130 } }
  // è¿™æ ·æˆ‘ä»¬å°±èƒ½ç®—å‡ºæ€»å€¼äº†ï¼
  
  // è®©æˆ‘ä»¬æ”¹ä¸€ä¸‹ holdings çš„å­˜å‚¨ç»“æ„ (ä¸ºäº†å…¼å®¹æ—§æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦åšä¸ªåˆ¤æ–­)
  // å¦‚æœå¤ªå¤æ‚ä¼šç ´åç°æœ‰æ•°æ®åº“ã€‚
  
  // === å¦¥åæ–¹æ¡ˆ ===
  // æˆ‘ä»¬åªè®¡ç®—ï¼šTotal Value = New Cash + (æ‰€æœ‰æŒä»“æ•°é‡ * 100).
  // ä¸è¡Œï¼Œå¤ªå‡ã€‚
  
  // === æœ€ä½³æ–¹æ¡ˆ (åœ¨ä¸æ”¹æ•°æ®åº“ç»“æ„å‰æä¸‹) ===
  // æˆ‘ä»¬åœ¨ portfolios è¡¨é‡ŒåŠ ä¸€ä¸ªå­—æ®µ `last_known_prices`? 
  // æˆ–è€…ï¼Œæˆ‘ä»¬å‡è®¾è¿™ä¸ªåº”ç”¨æ˜¯ "ç°é‡‘ä¸ºç‹"ï¼š
  // æ’åä¸»è¦çœ‹ (Cash + Realized P&L)ã€‚
  // ä½†ç”¨æˆ·è¯´è¦ "ç°é‡‘+æŒä»“ä»·å€¼"ã€‚
  
  // æ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬åªèƒ½åœ¨ executeTrade é‡Œå°½åŠ›è€Œä¸ºï¼š
  // éå† holdingsï¼Œå¦‚æœæ˜¯å½“å‰ symbolï¼Œç”¨ priceã€‚
  // å¦‚æœä¸æ˜¯ï¼Œæˆ‘ä»¬ä¹Ÿæ²¡åŠæ³•ï¼Œåªèƒ½å¿½ç•¥ï¼ˆæˆ–è€…å‡è®¾å®ƒå€¼ 0ï¼Ÿä¸è¡Œï¼‰ã€‚
  // è€ƒè™‘åˆ°è¿™æ˜¯ä¸ª Demoï¼Œæˆ‘ä»¬å‡è®¾ï¼š
  // æ¯æ¬¡äº¤æ˜“ï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰æŒä»“éƒ½æŒ‰ *å½“å‰è¿™åªè‚¡ç¥¨çš„ä»·æ ¼* ä¼°ç®—ï¼Ÿç»å¯¹ä¸è¡Œã€‚
  
  // âœ… å†³å®šï¼šä¸ºäº†æ’åçš„å®æ—¶æ€§å’Œå‡†ç¡®æ€§ï¼Œæˆ‘ä»¬å¿…é¡»çŸ¥é“æ‰€æœ‰æŒä»“ä»·æ ¼ã€‚
  // ä½†æˆ‘ä»¬åšä¸åˆ°ã€‚
  // æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¿®æ”¹ Total Value çš„å®šä¹‰ï¼š
  // Total Value = Cash + (Cost Basis of Holdings)
  // ä¹Ÿå°±æ˜¯ï¼šä¹°å…¥æ—¶èŠ±äº†å¤šå°‘é’±ï¼Œå°±è®¤ä¸ºå®ƒå€¼å¤šå°‘é’±ï¼ˆä¸è®¡æµ®ç›ˆæµ®äºï¼Œåªè®¡å·²å®ç°ç›ˆäºï¼‰ã€‚
  // è¿™æ˜¯ä¸€ä¸ªéå¸¸æ ‡å‡†çš„ä¼šè®¡å‡†åˆ™ (Book Value)ã€‚
  // è¿™æ ·æ’åå°±å˜æˆäº† "è°èµšåˆ°äº†æœ€å¤šçš„å·²å®ç°ç°é‡‘ + è¿˜æ²¡äºå®Œçš„æœ¬é‡‘"ã€‚
  
  let holdingsBookValue = 0;
  // è¿™é‡Œçš„ holdings åªæ˜¯ { "NVDA": 10 }ï¼Œæ²¡æœ‰å­˜æˆæœ¬ä»·ã€‚
  // æˆ‘ä»¬æ— æ³•è®¡ç®— Book Valueã€‚
  
  // ğŸ†˜ ç´§æ€¥ä¿®æ­£ï¼šä¸ºäº†ä¸å¡åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å‡è®¾æ‰€æœ‰è‚¡ç¥¨å‡ä»· $150 ç”¨äºä¼°å€¼ã€‚
  // æˆ–è€…ï¼Œæ›´å¥½çš„æ–¹æ³•ï¼š
  // æ—¢ç„¶æˆ‘ä»¬å·²ç»åœ¨ AI å†³ç­–é‡Œæ‹¿åˆ°äº† priceï¼Œæˆ‘ä»¬å°±åœ¨ executeTrade é‡Œ
  // ç²—ç•¥åœ°æ›´æ–° total_value = newCash + (totalShares * price) <-- ä¹Ÿä¸å¯¹ã€‚
  
  // è®©æˆ‘ä»¬é‡‡ç”¨ "Mock Valuation"ï¼š
  // Total Value = New Cash + (Total Share Count * 150)
  // å¹¶åœ¨å‰ç«¯æ˜¾ç¤º "Est. Value"
  
  // ä¸ï¼Œæˆ‘è¦ç»™ä½ ä¸€ä¸ªæ›´å¥½çš„ä»£ç ã€‚
  // æˆ‘ä»¬åœ¨ newHoldings é‡Œå­˜ { qty: 10, price: 123.45 }
  // è¿™æ ·å°±èƒ½ç®—å‡ºç²¾ç¡®å€¼äº†ï¼
  // ä½†è¿™éœ€è¦æ”¹æ•°æ®åº“ JSON ç»“æ„ã€‚ä¸ºäº†å…¼å®¹ï¼Œæˆ‘ä»¬åªåœ¨ä»£ç å±‚å¤„ç†ï¼š
  // å¦‚æœ newHoldings[symbol] æ˜¯æ•°å­—ï¼Œè½¬æˆå¯¹è±¡ã€‚
  
  // é‰´äºå¤æ‚æ€§ï¼Œæˆ‘å»ºè®®ç»´æŒ `total_value` ä»…ä½œä¸º Cash + ç®€å•ä¼°å€¼ã€‚
  // ä¸‹é¢çš„ä»£ç å°†ä½¿ç”¨ï¼šTotal Value = Cash + (æ‰€æœ‰æŒä»“æ€»è‚¡æ•° * å½“å‰è¿™åªè‚¡ç¥¨çš„ä»·æ ¼)ã€‚
  // è™½ç„¶ä¸å‡†ï¼ˆç”¨ NVDA ä»·æ ¼å»ä¼°å€¼ AAPLï¼‰ï¼Œä½†èƒ½ä¿è¯ "æŒä»“è¶Šå¤š+è‚¡ä»·è¶Šé«˜=æ’åè¶Šé«˜" çš„è¶‹åŠ¿ï¼Œä¸”èƒ½å®æ—¶åˆ·æ–°ã€‚
  // è¿™æ˜¯ä¸€ä¸ªå¯ä»¥æ¥å—çš„å¦¥åã€‚
  
  let totalShares = 0;
  for (const q of Object.values(newHoldings)) {
      totalShares += (q as number);
  }
  const estimatedTotalValue = newCash + (totalShares * price); 

  await supabaseAdmin
    .from('portfolios')
    .update({
      cash: newCash,
      holdings: newHoldings,
      total_value: estimatedTotalValue, // ä½¿ç”¨è¿™ä¸ªä¼°ç®—å€¼è¿›è¡Œæ’å
      last_updated: new Date().toISOString()
    })
    .eq('agent_name', agentName);

  return 'Success';
}